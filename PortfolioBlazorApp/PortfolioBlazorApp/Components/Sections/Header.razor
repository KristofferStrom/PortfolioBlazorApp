@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<header class="header" @ref="headerRef">
    <div class="container">
        <div class="logo">
            <a class="nav-link" @onclick='() => HandleClick("")' href="/">Kristofferström<span>.</span></a>
        </div>

        <nav class="nav-menu">
            <NavLink class="@(_currentUrl == "skills" ? "active nav-link link" : "nav-link link")" @onclick='() => HandleClick("skills")' href="#skills">Skills</NavLink>
            <NavLink class="@(_currentUrl == "projects" ? "active nav-link link" : "nav-link link")" @onclick='() => HandleClick("projects")' href="#projects">Projects</NavLink>
            <a href="mailto:kristoffer.strom@hotmail.se" class="btn btn-theme btn-email link"><i class="fa-sharp fa-regular fa-envelope"></i>Email Me</a>
        </nav>

    </div>
</header>

@code {
    ElementReference headerRef;
    private string _currentSectionId = "";
    private string _currentUrl = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var dotnetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("scrollHandler.listenForScroll", dotnetHelper);
        }
    }

    private async Task HandleClick(string sectionId)
    {
        await JSRuntime.InvokeVoidAsync("scrollHandler.disableUserScrolling");
        await FetchFragment();
        await JSRuntime.InvokeVoidAsync("scrollHandler.enableUserScrolling");
    }

    private async Task FetchFragment()
    {
        _currentUrl = await JSRuntime.InvokeAsync<string>("getFragment");
        StateHasChanged(); // Uppdatera komponenten för att visa det nya värdet
    }

    [JSInvokable]
    public async Task OnScroll(string currentSectionId)
    {

        if (currentSectionId != "")
            await JSRuntime.InvokeVoidAsync("blazorHelpers.changeUrl", "#" + currentSectionId);
        else
            await JSRuntime.InvokeVoidAsync("blazorHelpers.changeUrl", "");
            
        await FetchFragment();
        
    }


}

<script>

    window.scrollHandler = {
        isUserScrolling: true, // Initialisera flaggan

        listenForScroll: function (dotnetHelper) {
            window.addEventListener('scroll', () => {
                if (!this.isUserScrolling) return; // Kontrollera flaggan innan du fortsätter

                var sections = document.querySelectorAll('section');
                var currentSectionId = "";

                sections.forEach(function (section) {
                    var sectionTop = section.offsetTop;
                    var sectionHeight = section.offsetHeight;

                    if (pageYOffset >= (sectionTop - sectionHeight / 3) && pageYOffset < (sectionTop + sectionHeight - sectionHeight / 3)) {
                        currentSectionId = section.id;
                    }
                });

                dotnetHelper.invokeMethodAsync('OnScroll', currentSectionId);
            });
        },

        disableUserScrolling: function () {
            this.isUserScrolling = false;
        },

        enableUserScrolling: function () {
            setTimeout(() => {
                this.isUserScrolling = true;
            }, 500); // Justera fördröjningen efter behov
        }
    };


    window.blazorHelpers = {
        changeUrl: (newUrl) => {
            window.history.pushState({}, '', newUrl);
        }
    };

    window.getFragment = () => {
        return window.location.hash.substring(1);
    }


  



</script>